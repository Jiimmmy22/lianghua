<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票数据分析</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
        #chart-container {
            width: 100%;
            height: 400px;
            background-color: #666666;
            border-radius: 5px;
        }
        #chan-chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            background-color: #666666;
            border-radius: 5px;
            overflow: hidden;
        }
        .data-section {
            display: none;
        }
        .chart-card {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .chart-header {
            background-color: #f1f1f1;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
        }
        /* 修改卡片样式，使其更简洁 */
        .card {
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f1f1f1;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">股票数据分析</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>输入查询参数</h5>
            </div>
            <div class="card-body">
                <form id="stock-form" action="/chan_analysis" method="post">
                    <div class="mb-3">
                        <label for="stock-code" class="form-label">股票代码</label>
                        <input type="text" class="form-control" id="stock-code" name="stock" placeholder="例如：000001（平安银行）、600519（贵州茅台）" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start-date" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="start-date" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="end-date" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="end-date" name="end_date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">分析</button>
                </form>
            </div>
        </div>

        <div class="loading">
            <div class="spinner-border loading-spinner text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p>正在获取数据，请稍候...</p>
        </div>

        <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
        
        <div id="data-section" class="data-section">
            <h2 id="stock-name" class="mb-3"></h2>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>股价走势图</h5>
                </div>
                <div class="card-body">
                    <!-- 主图表容器 -->
                    <div id="chan-chart-container"></div>
                    
                    <!-- 图表说明和控制区 -->
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div>
                            <span class="badge bg-danger me-2">卖出信号</span>
                            <span class="badge bg-success me-2">买入信号</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="zoom-reset">重置缩放</button>
                            <button class="btn btn-sm btn-outline-secondary" id="toggle-view">切换视图</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>缠论分析</h5>
                </div>
                <div class="card-body">
                    <div class="mt-3">
                        <h6>分析结果:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">顶分型</div>
                                    <div class="card-body">
                                        <ul id="peaks-list" class="list-group list-group-flush"></ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">底分型</div>
                                    <div class="card-body">
                                        <ul id="troughs-list" class="list-group list-group-flush"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card mb-3">
                            <div class="card-header">中枢</div>
                            <div class="card-body">
                                <ul id="centers-list" class="list-group list-group-flush"></ul>
                            </div>
                        </div>
                        
                        <!-- 添加的买卖信号卡片 -->
                        <div class="card mb-3">
                            <div class="card-header">买卖信号</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>买入信号</h6>
                                        <div class="d-flex justify-content-around mb-2">
                                            <span class="badge bg-success" id="buy-signal-count">0</span>
                                        </div>
                                        <ul id="buy-signals-list" class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                第一类买点 (B1)
                                                <span class="badge bg-success rounded-pill" id="buy1-count">0</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                第二类买点 (B2)
                                                <span class="badge bg-info rounded-pill" id="buy2-count">0</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                第三类买点 (B3)
                                                <span class="badge bg-primary rounded-pill" id="buy3-count">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>卖出信号</h6>
                                        <div class="d-flex justify-content-around mb-2">
                                            <span class="badge bg-danger" id="sell-signal-count">0</span>
                                        </div>
                                        <ul id="sell-signals-list" class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                第一类卖点 (S1)
                                                <span class="badge bg-danger rounded-pill" id="sell1-count">0</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                第二类卖点 (S2)
                                                <span class="badge bg-warning text-dark rounded-pill" id="sell2-count">0</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                第三类卖点 (S3)
                                                <span class="badge bg-secondary rounded-pill" id="sell3-count">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3" id="trading-signals-details">
                                    <h6>详细信号列表:</h6>
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>日期</th>
                                                <th>类型</th>
                                                <th>价格</th>
                                                <th>描述</th>
                                            </tr>
                                        </thead>
                                        <tbody id="signals-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5>最新数据记录</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>开盘价</th>
                                    <th>最高价</th>
                                    <th>最低价</th>
                                    <th>收盘价</th>
                                    <th>涨跌幅</th>
                                    <th>成交量</th>
                                </tr>
                            </thead>
                            <tbody id="data-table"></tbody>
                        </table>
                        <div class="text-center">
                            <a href="/download_data" class="btn btn-outline-primary btn-sm">下载完整数据</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = oneYearAgo.toISOString().split('T')[0];
            
            // 检查是否有错误消息
            const errorMessage = "{{ error }}";
            if (errorMessage && errorMessage.trim() !== '') {
                document.getElementById('error-message').textContent = errorMessage;
                document.getElementById('error-message').style.display = 'block';
            }
            
            // 检查是否有图表数据
            const chartData = "{{ chart_data }}";
            if (chartData && chartData.trim() !== '') {
                document.getElementById('data-section').style.display = 'block';
                
                // 如果有数据，则更新股票名称
                const stockName = "{{ stock_name }}";
                const stockCode = "{{ stock_code }}";
                if (stockName && stockCode) {
                    document.getElementById('stock-name').textContent = `${stockName} (${stockCode})`;
                }
                
                // 解析统计信息
                try {
                    const stats = JSON.parse('{{ stats|tojson }}');
                    if (stats) {
                        // 更新买入信号计数
                        if (stats.买入信号数量 !== undefined) {
                            document.getElementById('buy-signal-count').textContent = stats.买入信号数量;
                        }
                        
                        // 更新卖出信号计数
                        if (stats.卖出信号数量 !== undefined) {
                            document.getElementById('sell-signal-count').textContent = stats.卖出信号数量;
                        }
                    }
                } catch (e) {
                    console.error('解析统计信息出错:', e);
                }
                
                // 解析买入信号数据
                try {
                    const buySignals = JSON.parse('{{ buy_signals|tojson }}');
                    if (buySignals && buySignals.length > 0) {
                        const buy1Count = buySignals.filter(s => s.type === 1).length;
                        const buy2Count = buySignals.filter(s => s.type === 2).length;
                        const buy3Count = buySignals.filter(s => s.type === 3).length;
                        
                        document.getElementById('buy1-count').textContent = buy1Count;
                        document.getElementById('buy2-count').textContent = buy2Count;
                        document.getElementById('buy3-count').textContent = buy3Count;
                    }
                } catch (e) {
                    console.error('解析买入信号数据出错:', e);
                }
                
                // 解析卖出信号数据
                try {
                    const sellSignals = JSON.parse('{{ sell_signals|tojson }}');
                    if (sellSignals && sellSignals.length > 0) {
                        const sell1Count = sellSignals.filter(s => s.type === 1).length;
                        const sell2Count = sellSignals.filter(s => s.type === 2).length;
                        const sell3Count = sellSignals.filter(s => s.type === 3).length;
                        
                        document.getElementById('sell1-count').textContent = sell1Count;
                        document.getElementById('sell2-count').textContent = sell2Count;
                        document.getElementById('sell3-count').textContent = sell3Count;
                    }
                } catch (e) {
                    console.error('解析卖出信号数据出错:', e);
                }
                
                // 填充信号详情表格
                try {
                    const buySignals = JSON.parse('{{ buy_signals|tojson }}') || [];
                    const sellSignals = JSON.parse('{{ sell_signals|tojson }}') || [];
                    
                    // 合并信号并按日期排序
                    const allSignals = [];
                    buySignals.forEach(signal => allSignals.push({...signal, signalType: 'buy'}));
                    sellSignals.forEach(signal => allSignals.push({...signal, signalType: 'sell'}));
                    allSignals.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // 填充表格
                    const signalsTable = document.getElementById('signals-table');
                    signalsTable.innerHTML = '';
                    
                    allSignals.forEach(signal => {
                        const row = document.createElement('tr');
                        
                        const typeText = signal.signalType === 'buy' 
                            ? `第${signal.type}类买点` 
                            : `第${signal.type}类卖点`;
                        
                        const typeClass = signal.signalType === 'buy' ? 'text-success' : 'text-danger';
                        
                        const descText = signal.signalType === 'buy'
                            ? getBuySignalDescription(signal.type)
                            : getSellSignalDescription(signal.type);
                        
                        row.innerHTML = `
                            <td>${signal.date}</td>
                            <td class="${typeClass}">${typeText}</td>
                            <td>${signal.price.toFixed(2)}</td>
                            <td>${descText}</td>
                        `;
                        
                        signalsTable.appendChild(row);
                    });
                    
                    // 如果没有信号，显示空信息
                    if (allSignals.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="4" class="text-center">暂无买卖信号数据</td>';
                        signalsTable.appendChild(row);
                    }
                } catch (e) {
                    console.error('填充信号详情表格出错:', e);
                }
                
                // 填充分型列表
                try {
                    const peaks = JSON.parse('{{ peaks|tojson }}') || [];
                    const troughs = JSON.parse('{{ troughs|tojson }}') || [];
                    
                    // 顶分型
                    const peaksList = document.getElementById('peaks-list');
                    peaksList.innerHTML = '';
                    
                    if (peaks.length > 0) {
                        peaks.forEach(peak => {
                            const item = document.createElement('li');
                            item.className = 'list-group-item';
                            item.textContent = `${peak.date}: ${peak.price.toFixed(2)}`;
                            peaksList.appendChild(item);
                        });
                    } else {
                        const item = document.createElement('li');
                        item.className = 'list-group-item';
                        item.textContent = '无顶分型数据';
                        peaksList.appendChild(item);
                    }
                    
                    // 底分型
                    const troughsList = document.getElementById('troughs-list');
                    troughsList.innerHTML = '';
                    
                    if (troughs.length > 0) {
                        troughs.forEach(trough => {
                            const item = document.createElement('li');
                            item.className = 'list-group-item';
                            item.textContent = `${trough.date}: ${trough.price.toFixed(2)}`;
                            troughsList.appendChild(item);
                        });
                    } else {
                        const item = document.createElement('li');
                        item.className = 'list-group-item';
                        item.textContent = '无底分型数据';
                        troughsList.appendChild(item);
                    }
                } catch (e) {
                    console.error('填充分型列表出错:', e);
                }
                
                // 填充中枢列表
                try {
                    const priceCenters = JSON.parse('{{ price_centers|tojson }}') || [];
                    
                    const centersList = document.getElementById('centers-list');
                    centersList.innerHTML = '';
                    
                    if (priceCenters.length > 0) {
                        priceCenters.forEach(center => {
                            const item = document.createElement('li');
                            item.className = 'list-group-item';
                            item.textContent = `${center.start} - ${center.end}: 上边界 ${center.zg.toFixed(2)}, 下边界 ${center.zd.toFixed(2)}`;
                            centersList.appendChild(item);
                        });
                    } else {
                        const item = document.createElement('li');
                        item.className = 'list-group-item';
                        item.textContent = '无中枢数据';
                        centersList.appendChild(item);
                    }
                } catch (e) {
                    console.error('填充中枢列表出错:', e);
                }
                
                // 显示图表
                if (chartData) {
                    try {
                        // 创建ECharts实例
                        const chartDom = document.getElementById('chan-chart-container');
                        const myChart = echarts.init(chartDom);
                        
                        // 处理数据
                        const stockData = JSON.parse('{{ stock_data|tojson }}') || [];
                        const peaks = JSON.parse('{{ peaks|tojson }}') || [];
                        const troughs = JSON.parse('{{ troughs|tojson }}') || [];
                        const buySignals = JSON.parse('{{ buy_signals|tojson }}') || [];
                        const sellSignals = JSON.parse('{{ sell_signals|tojson }}') || [];
                        const strokesData = JSON.parse('{{ strokes|tojson }}') || [];
                        
                        // 准备日期和价格数据
                        const dates = stockData.map(item => new Date(item.date || item.Date));
                        const prices = stockData.map(item => parseFloat(item.close || item.Close));
                        
                        // 准备分型点数据
                        const peakPoints = peaks.map(peak => {
                            return [new Date(peak.date), peak.price];
                        });
                        
                        const troughPoints = troughs.map(trough => {
                            return [new Date(trough.date), trough.price];
                        });
                        
                        // 准备买卖信号点数据
                        const buyPoints = buySignals.map(signal => {
                            return [new Date(signal.date), signal.price];
                        });
                        
                        const sellPoints = sellSignals.map(signal => {
                            return [new Date(signal.date), signal.price];
                        });
                        
                        // 准备笔数据（线段连接）
                        const strokeLines = strokesData.map(stroke => {
                            return {
                                name: '笔',
                                type: 'line',
                                data: [
                                    [new Date(stroke.start_date), stroke.start_val],
                                    [new Date(stroke.end_date), stroke.end_val]
                                ],
                                lineStyle: {
                                    color: '#2a93fc',
                                    width: 1.5
                                },
                                symbol: 'none',
                                z: 2
                            };
                        });
                        
                        // 图表配置
                        const option = {
                            backgroundColor: '#666666',
                            textStyle: {
                                color: '#ffffff'
                            },
                            title: {
                                text: '{{ stock_name }} ({{ stock_code }})',
                                left: 'center',
                                textStyle: {
                                    color: '#ffffff'
                                }
                            },
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    let tip = '';
                                    for (let i = 0; i < params.length; i++) {
                                        const param = params[i];
                                        if (param.seriesName === '价格') {
                                            const date = new Date(param.value[0]);
                                            const dateStr = date.getFullYear() + '/' + 
                                                           (date.getMonth() + 1) + '/' + 
                                                           date.getDate();
                                            tip = dateStr + '<br/>' + param.seriesName + ': ' + param.value[1].toFixed(2);
                                        } else if (param.seriesName !== '笔' && param.value instanceof Array) {
                                            tip += '<br/>' + param.seriesName + ': ' + param.value[1].toFixed(2);
                                        }
                                    }
                                    return tip;
                                }
                            },
                            grid: {
                                left: '5%',
                                right: '5%',
                                bottom: '10%',
                                top: '15%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'time',
                                axisLine: {
                                    lineStyle: {
                                        color: '#999999'
                                    }
                                },
                                axisLabel: {
                                    formatter: function(value) {
                                        const date = new Date(value);
                                        return date.getFullYear() + '/' + (date.getMonth() + 1);
                                    },
                                    color: '#ffffff'
                                },
                                splitLine: {
                                    show: false
                                }
                            },
                            yAxis: {
                                type: 'value',
                                axisLine: {
                                    lineStyle: {
                                        color: '#999999'
                                    }
                                },
                                axisLabel: {
                                    color: '#ffffff'
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: '#777777',
                                        type: 'dashed'
                                    }
                                }
                            },
                            dataZoom: [
                                {
                                    type: 'inside',
                                    start: 0,
                                    end: 100
                                },
                                {
                                    show: true,
                                    type: 'slider',
                                    bottom: '5px',
                                    height: 20,
                                    start: 0,
                                    end: 100,
                                    textStyle: {
                                        color: '#ffffff'
                                    },
                                    borderColor: '#999999',
                                    fillerColor: 'rgba(200, 200, 200, 0.3)',
                                    handleStyle: {
                                        color: '#dddddd'
                                    }
                                }
                            ],
                            series: [
                                {
                                    name: '价格',
                                    type: 'line',
                                    data: dates.map((date, i) => [date, prices[i]]),
                                    smooth: false,
                                    symbol: 'none',
                                    lineStyle: {
                                        color: '#ffffff',
                                        width: 1.5
                                    },
                                    z: 1
                                },
                                {
                                    name: '顶分型',
                                    type: 'scatter',
                                    symbolSize: 6,
                                    itemStyle: {
                                        color: 'red'
                                    },
                                    data: peakPoints,
                                    z: 2
                                },
                                {
                                    name: '底分型',
                                    type: 'scatter',
                                    symbolSize: 6,
                                    itemStyle: {
                                        color: 'green'
                                    },
                                    data: troughPoints,
                                    z: 2
                                },
                                {
                                    name: '买入信号',
                                    type: 'scatter',
                                    symbol: 'triangle',
                                    symbolSize: 10,
                                    itemStyle: {
                                        color: 'lime'
                                    },
                                    data: buyPoints,
                                    z: 3
                                },
                                {
                                    name: '卖出信号',
                                    type: 'scatter',
                                    symbol: 'triangle-down',
                                    symbolSize: 10,
                                    itemStyle: {
                                        color: 'red'
                                    },
                                    data: sellPoints,
                                    z: 3
                                },
                                ...strokeLines
                            ]
                        };
                        
                        // 设置图表选项
                        myChart.setOption(option);
                        
                        // 监听窗口大小变化，调整图表尺寸
                        window.addEventListener('resize', function() {
                            myChart.resize();
                        });
                        
                        // 绑定重置缩放按钮事件
                        document.getElementById('zoom-reset').addEventListener('click', function() {
                            myChart.dispatchAction({
                                type: 'dataZoom',
                                start: 0,
                                end: 100
                            });
                        });
                        
                        // 绑定切换视图按钮
                        document.getElementById('toggle-view').addEventListener('click', function() {
                            const container = document.getElementById('chan-chart-container');
                            
                            // 检查当前显示的是ECharts还是图片
                            if (container.querySelector('canvas')) {
                                // 当前是ECharts，切换到图片
                                myChart.dispose();
                                
                                const imgElement = document.createElement('img');
                                imgElement.src = 'data:image/png;base64,' + chartData;
                                imgElement.className = 'img-fluid';
                                imgElement.style.width = '100%';
                                imgElement.style.height = '100%';
                                imgElement.style.objectFit = 'contain';
                                
                                container.innerHTML = '';
                                container.appendChild(imgElement);
                                
                                // 更新按钮文本
                                this.textContent = '切换到图表';
                            } else {
                                // 当前是图片，切换到ECharts
                                container.innerHTML = '';
                                
                                // 重新初始化ECharts
                                const newChart = echarts.init(container);
                                newChart.setOption(option);
                                myChart = newChart;
                                
                                // 更新按钮文本
                                this.textContent = '切换视图';
                                
                                // 重新绑定resize事件
                                window.addEventListener('resize', function() {
                                    newChart.resize();
                                });
                            }
                        });
                    } catch (e) {
                        console.error('创建图表出错:', e);
                        // 如果ECharts失败，回退到原来的图片显示
                        const imgElement = document.createElement('img');
                        imgElement.src = 'data:image/png;base64,' + chartData;
                        imgElement.className = 'img-fluid';
                        imgElement.style.width = '100%';
                        imgElement.style.height = '100%';
                        imgElement.style.objectFit = 'contain';
                        
                        const container = document.getElementById('chan-chart-container');
                        container.innerHTML = '';
                        container.appendChild(imgElement);
                    }
                }
                
                // 填充数据表格
                try {
                    const stockData = JSON.parse('{{ stock_data|tojson }}') || [];
                    
                    // 只显示最近10条数据
                    const recentData = stockData.slice(-10).reverse();
                    
                    const tableBody = document.getElementById('data-table');
                    tableBody.innerHTML = '';
                    
                    // 前一个收盘价
                    let prevClose = 0;
                    
                    recentData.forEach((record, index) => {
                        const row = document.createElement('tr');
                        
                        // 计算涨跌幅
                        let changePercent = 0;
                        if (index > 0 && prevClose > 0) {
                            changePercent = (parseFloat(record.close) - prevClose) / prevClose * 100;
                        } else if (stockData.length > recentData.length) {
                            // 获取前一天收盘价
                            const prevRecord = stockData[stockData.length - recentData.length - 1];
                            if (prevRecord && prevRecord.close) {
                                prevClose = parseFloat(prevRecord.close);
                                changePercent = (parseFloat(record.close) - prevClose) / prevClose * 100;
                            }
                        }
                        
                        // 更新前一个收盘价
                        prevClose = parseFloat(record.close);
                        
                        // 创建表格行
                        const date = record.date || record.Date || '';
                        const open = parseFloat(record.open || record.Open || 0).toFixed(2);
                        const high = parseFloat(record.high || record.High || 0).toFixed(2);
                        const low = parseFloat(record.low || record.Low || 0).toFixed(2);
                        const close = parseFloat(record.close || record.Close || 0).toFixed(2);
                        const volume = parseInt(record.volume || record.Volume || 0).toLocaleString();
                        
                        // 创建涨跌幅单元格，添加颜色
                        const changePercentStr = changePercent.toFixed(2) + '%';
                        const changeClass = changePercent > 0 ? 'text-danger' : (changePercent < 0 ? 'text-success' : 'text-muted');
                        const changeSign = changePercent > 0 ? '+' : '';
                        
                        row.innerHTML = `
                            <td>${date}</td>
                            <td>${open}</td>
                            <td>${high}</td>
                            <td>${low}</td>
                            <td>${close}</td>
                            <td class="${changeClass}">${changeSign}${changePercentStr}</td>
                            <td>${volume}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // 如果没有数据，显示提示
                    if (recentData.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="7" class="text-center">暂无数据</td>';
                        tableBody.appendChild(row);
                    }
                } catch (e) {
                    console.error('填充数据表格出错:', e);
                }
            }
            
            // 添加表单提交事件处理
            const stockForm = document.getElementById('stock-form');
            if (stockForm) {
                stockForm.addEventListener('submit', function() {
                    // 显示加载状态
                    document.querySelector('.loading').style.display = 'block';
                    document.getElementById('data-section').style.display = 'none';
                    document.getElementById('error-message').style.display = 'none';
                    
                    // 禁用提交按钮
                    const submitButton = this.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 分析中...';
                    }
                    
                    // 继续正常提交表单
                    return true;
                });
            }
        });
        
        // 获取买入信号的描述
        function getBuySignalDescription(type) {
            switch (type) {
                case 1:
                    return '下跌趋势结束，底分型且背驰';
                case 2:
                    return '第一类买点后的回调不破前低';
                case 3:
                    return '突破中枢后回调不破上沿';
                default:
                    return '未知买入信号';
            }
        }
        
        // 获取卖出信号的描述
        function getSellSignalDescription(type) {
            switch (type) {
                case 1:
                    return '上涨趋势结束，顶分型且背驰';
                case 2:
                    return '第一类卖点后的反弹不破前高';
                case 3:
                    return '跌破中枢后反抽不破下沿';
                default:
                    return '未知卖出信号';
            }
        }
    </script>
</body>
</html> 